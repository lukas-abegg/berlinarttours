%html
  %head
    %meta{:content => "initial-scale=1.0, user-scalable=no", :name => "viewport"}/
    %meta{:charset => "utf-8"}/
    %title Draggable directions
    :css
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    %script{:src => "https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"}
    :javascript

      var rendererOptions = {
        draggable: true
      };
      var directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);;
      var directionsService = new google.maps.DirectionsService();
      var map;

      var berlin = new google.maps.LatLng(52.565039, 13.366349);
      var trip_stations = $.parseJSON("#{j @trip_stations_js}");

      function initialize() {


      var mapOptions = {
        zoom: 7,
        center: berlin
      };
      map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
      directionsDisplay.setMap(map);
      directionsDisplay.setPanel(document.getElementById('directionsPanel'));

      google.maps.event.addListener(directionsDisplay, 'directions_changed', function() {
        computeTotalDistance(directionsDisplay.getDirections());
      });

      calcRoute(trip_stations);
      }

      function calcRoute(waypointsArr) {
        var waypointsArr = [];

        trip_stations.forEach(function(station) {
          var point =  new google.maps.LatLng(station.location[1], station.location[0]);
          waypointsArr.push({
            location: point,
            stopover:true}
          );
        });

        var origin = waypointsArr[0].location;
        var destination = waypointsArr[waypointsArr.length-1].location;
        waypointsArr.shift;
        waypointsArr.pop;

        var request = {
          origin: origin,
          destination: destination,
          waypoints: waypointsArr,
          optimizeWaypoints: true,
          travelMode: google.maps.TravelMode.DRIVING
        };
        directionsService.route(request, function(response, status) {
          if (status == google.maps.DirectionsStatus.OK) {
            directionsDisplay.setDirections(response);
          }
        });
      }

      function computeTotalDistance(result) {
        var total = 0;
        var myroute = result.routes[0];
        for (var i = 0; i < myroute.legs.length; i++) {
          total += myroute.legs[i].distance.value;
        }
        total = total / 1000.0;
        document.getElementById('total').innerHTML = total + ' km';
      }

      google.maps.event.addDomListener(window, 'load', initialize);

  %body
    %p
      #map-canvas{:style => "float:left;width:100%; height:40%"}
      //#directionsPanel{:style => "float:right;width:30%;height 40%"}
    %p
      Gesamte Distanz:
      %span#total